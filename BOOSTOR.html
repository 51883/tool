<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOOSTOR Pro Geometry</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* å…¨å±€é‡ç½® */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.15);
            --highlight: #f59e0b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            
            --radius-input: 10px;
            --radius-card: 16px;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            padding: 30px 15px;
            line-height: 1.6;
        }

        .container { max-width: 960px; margin: 0 auto; }

        h1 {
            text-align: center; font-weight: 800; font-size: 2rem; letter-spacing: -0.03em;
            color: var(--primary); margin-bottom: 5px;
        }
        .sub-header {
            text-align: center; color: var(--text-sub); margin-bottom: 40px; font-size: 0.95rem;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media(max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; gap: 20px; }
            body { padding: 20px 10px; }
        }

        .panel {
            background: var(--bg-card); padding: 25px; border-radius: var(--radius-card);
            box-shadow: var(--shadow-soft); border: 1px solid var(--border);
            transition: transform 0.2s;
        }
        .panel-new { border-top: 4px solid var(--primary); }

        .panel-title {
            font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 20px;
            display: flex; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border);
        }

        .input-group { margin-bottom: 18px; width: 100%; }
        label {
            display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text-sub); font-weight: 600; margin-bottom: 6px;
        }
        input, select {
            width: 100%; padding: 12px 15px; font-size: 0.95rem; font-weight: 600;
            color: var(--primary); background: #fff; border: 1px solid var(--border);
            border-radius: var(--radius-input); transition: all 0.2s ease;
            -webkit-appearance: none; appearance: none;
        }
        input:focus, select:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow);
        }
        .input-error {
            border-color: #ef4444;
            background: #fff5f5;
            color: #7f1d1d;
        }
        .input-error:focus {
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.2em; cursor: pointer;
        }

        .locked-input { background-color: #f8fafc; color: #94a3b8; border-color: #f1f5f9; cursor: default; }
        .spacer-input { border-color: var(--highlight); color: #b45309; background-color: #fffbeb; }
        
        .tag {
            display: inline-block; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
            margin-left: 6px; vertical-align: middle; transform: translateY(-1px);
        }
        .tag-fix { background: #e2e8f0; color: #64748b; }
        .tag-edit { background: #dbeafe; color: #1e40af; }

        .canvas-container {
            display: none;
            position: relative; background: #fff; border-radius: var(--radius-card);
            border: 1px solid var(--border); padding: 10px; box-shadow: var(--shadow-soft);
            margin-top: 30px; overflow: hidden;
        }
        canvas { width: 100%; height: auto; display: block; }

        .alert-box {
            background: #fff; border-radius: var(--radius-card); padding: 25px;
            margin-top: 30px; display: none; border-left: 5px solid #ccc; box-shadow: var(--shadow-hover);
        }
        .alert-success { border-color: #10b981; background: #ecfdf5; }
        .alert-danger { border-color: #ef4444; background: #fef2f2; }
        .alert-warning { border-color: #f59e0b; background: #fffbeb; }

        .metric-row {
            display: flex; justify-content: space-around; text-align: center;
            margin: 15px 0; padding: 20px 0; background: rgba(255,255,255,0.6);
            border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);
        }
        .metric-val { font-size: 1.6rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 5px; }
        .metric-lbl { font-size: 0.8rem; color: var(--text-sub); text-transform: uppercase; margin-top: 5px; font-weight: 600;}
        .metric-icon { font-size: 0.8em; opacity: 0.8; }
        
        .legend {
            position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9);
            padding: 10px; border-radius: 8px; border: 1px solid #eee; font-size: 0.8rem;
            color: #555; pointer-events: none;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
    </style>
</head>
<body>

<div class="container">
    <h1>BOOSTOR Pro</h1>
    <div class="sub-header">ä¸“ä¸šçº§ä¸€ä½“æŠŠå®‰è£…ä¸å‡ ä½•åˆ†æç³»ç»Ÿ (V5.2)</div>

    <div class="grid-2">
        <div class="panel">
            <div class="panel-title">ğŸš² <span>åŸè½¦è®¾å®š (Old)</span></div>
            
            <div class="input-group">
                <label>Reach (å‰ä¼¸é‡)</label>
                <input type="number" id="oldReach" value="80">
            </div>
            <div class="grid-2" style="margin-bottom: 0; gap: 15px;">
                <div class="input-group">
                    <label>æŠŠç«‹é•¿åº¦</label>
                    <input type="number" id="oldStemLen" value="100">
                </div>
                <div class="input-group">
                    <label>æŠŠç«‹è§’åº¦ (Â°)</label>
                    <input type="number" id="oldStemAng" value="-6" placeholder="é€šå¸¸ä¸º -6">
                </div>
            </div>
            <div class="input-group">
                <label>å«åœˆé«˜åº¦ (Spacer) <span style="color:#ef4444">*</span></label>
                <input type="number" id="oldSpacer" value="20">
            </div>
            <div class="input-group">
                <label>å¤´ç®¡è§’åº¦ (HTA)</label>
                <input type="number" id="hta" value="73">
            </div>
        </div>

        <div class="panel panel-new">
            <div class="panel-title">ğŸ›’ <span>ç›®æ ‡è®¾å®š (New)</span></div>
            
            <div class="input-group">
                <label>é€‰æ‹©äº§å“è§„æ ¼</label>
                <select id="productSelect"></select>
            </div>

            <div id="specDetail" style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:20px; display:none;">
                <div style="font-size:0.85em; color:#64748b; margin-bottom:5px;">è§„æ ¼è¯¦æƒ…</div>
                <div id="specText" style="font-weight:700; color:#0f172a;"></div>
            </div>

            <div class="grid-2" style="margin-bottom: 0; gap: 15px;">
                <div class="input-group">
                    <label>æ–°æŠŠç«‹é•¿åº¦ <span id="tagLen" class="tag tag-fix">å›ºå®š</span></label>
                    <input type="number" id="newStemLen" class="locked-input" readonly>
                </div>
                <div class="input-group">
                    <label>æ–°æŠŠç«‹è§’åº¦ (Â°) <span id="tagAng" class="tag tag-fix">å›ºå®š</span></label>
                    <input type="number" id="newStemAng" class="locked-input" readonly>
                </div>
            </div>

            <div class="input-group">
                <label>æ–°è½¦æŠŠ Reach <span id="tagReach" class="tag tag-fix">å›ºå®š</span></label>
                <input type="number" id="newReach" class="locked-input" readonly>
            </div>
            
            <input type="hidden" id="newRise">

            <div class="input-group" style="margin-top: 20px;">
                <label style="color:var(--highlight); display:flex; align-items:center;">
                    ğŸ”§ æ¨¡æ‹Ÿè°ƒæ•´ï¼šå«åœˆé«˜åº¦ (mm)
                </label>
                <input type="number" id="newSpacer" value="20" class="spacer-input">
            </div>
        </div>
    </div>

    <div id="reportCard" class="alert-box">
        <div id="reportContent"></div>
    </div>

    <div class="canvas-container">
        <canvas id="simCanvas" width="900" height="500"></canvas>
        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:#cbd5e1; border:1px dashed #64748b;"></div> åŸè®¾ç½®</div>
            <div class="legend-item"><div class="dot" style="background:#0f172a;"></div> æ–°è®¾ç½®</div>
        </div>
    </div>
</div>

<script>
    // === æ ¸å¿ƒæ•°æ®é…ç½® ===
    const FIX_REACH = 70;
    const FIX_DROP = 125;
    const FIX_RISE = 8; // äºŒæ¬¡æŠ¬å‡
    const CANVAS_ASPECT = 500 / 900;
    const CANVAS_BASE = { width: 900, height: 500, scale: 2.5, originX: 200, originY: 400 };

    const canvasState = { width: CANVAS_BASE.width, height: CANVAS_BASE.height, dpr: 1 };
    const inputRules = [
        { id: 'oldReach', label: 'æ—§è½¦ Reach', min: 0, max: 200, step: 0.1 },
        { id: 'oldStemLen', label: 'æ—§è½¦æŠŠç«‹é•¿åº¦', min: 40, max: 200, step: 0.1 },
        { id: 'oldStemAng', label: 'æ—§è½¦æŠŠç«‹è§’åº¦', min: -30, max: 30, step: 0.1 },
        { id: 'oldSpacer', label: 'æ—§è½¦å«åœˆé«˜åº¦', min: 0, max: 80, step: 0.1 },
        { id: 'hta', label: 'å¤´ç®¡è§’åº¦', min: 60, max: 90, step: 0.1 },
        { id: 'newStemLen', label: 'æ–°æŠŠç«‹é•¿åº¦', min: 40, max: 200, step: 0.1 },
        { id: 'newStemAng', label: 'æ–°æŠŠç«‹è§’åº¦', min: -30, max: 30, step: 0.1 },
        { id: 'newReach', label: 'æ–°è½¦æŠŠ Reach', min: 0, max: 200, step: 0.1 },
        { id: 'newSpacer', label: 'æ–°å«åœˆé«˜åº¦', min: 0, max: 80, step: 0.1 }
    ];
    
    // æ³¨æ„ï¼šæ–°äº§å“çš„è§’åº¦æ˜¯å›ºå®šçš„è´Ÿæ•°
    const myProducts = [
        { name: "è¯·é€‰æ‹©è§„æ ¼...", value: "none" }, 
        { name: "90mm (14.8Â°)", stemLen: 90, stemAng: 14.8, reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "100mm (11.4Â°)", stemLen: 100, stemAng: 11.4, reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "110mm (9.2Â°)",  stemLen: 110, stemAng: 9.2,  reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "120mm (7.2Â°)",  stemLen: 120, stemAng: 7.2,  reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "130mm (5.56Â°)", stemLen: 130, stemAng: 5.56, reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "---", value: "none" },
        { name: "ğŸ› ï¸ è‡ªå®šä¹‰æ¨¡å¼", value: "custom", stemLen: 100, stemAng: -6, reach: 75, drop: 125, rise: 8 }
    ];

    const dom = {
        select: document.getElementById('productSelect'),
        specDetail: document.getElementById('specDetail'),
        specText: document.getElementById('specText'),
        inputs: document.querySelectorAll('input'),
        canvas: document.getElementById('simCanvas'),
        report: document.getElementById('reportCard'),
        reportContent: document.getElementById('reportContent'),
        newStemLen: document.getElementById('newStemLen'),
        newStemAng: document.getElementById('newStemAng'),
        newReach: document.getElementById('newReach'),
        newRise: document.getElementById('newRise'),
        newSpacer: document.getElementById('newSpacer'),
        tags: {
            len: document.getElementById('tagLen'),
            ang: document.getElementById('tagAng'),
            reach: document.getElementById('tagReach')
        }
    };

    function applyInputRules() {
        inputRules.forEach(rule => {
            const el = document.getElementById(rule.id);
            if (!el) return;
            el.min = rule.min;
            el.max = rule.max;
            el.step = rule.step;
            el.setAttribute('inputmode', 'decimal');
            el.dataset.label = rule.label;
        });
    }

    function markInvalid(el) {
        el.classList.add('input-error');
        el.setAttribute('aria-invalid', 'true');
    }

    function clearInvalid(el) {
        el.classList.remove('input-error');
        el.removeAttribute('aria-invalid');
    }

    function clearValidation() {
        inputRules.forEach(rule => {
            const el = document.getElementById(rule.id);
            if (!el) return;
            clearInvalid(el);
        });
    }

    function validateInputs() {
        const errors = [];
        inputRules.forEach(rule => {
            const el = document.getElementById(rule.id);
            if (!el) return;
            const raw = el.value.trim();
            if (raw === "") {
                markInvalid(el);
                errors.push(`${rule.label} ä¸èƒ½ä¸ºç©º`);
                return;
            }
            const value = Number(raw);
            if (!Number.isFinite(value)) {
                markInvalid(el);
                errors.push(`${rule.label} è¯·è¾“å…¥æ•°å­—`);
                return;
            }
            if (value < rule.min || value > rule.max) {
                markInvalid(el);
                errors.push(`${rule.label} èŒƒå›´ ${rule.min}~${rule.max}`);
                return;
            }
            clearInvalid(el);
        });
        return errors;
    }

    function showValidationError(message) {
        dom.report.className = 'alert-box alert-danger';
        dom.report.style.display = 'block';
        dom.reportContent.innerHTML = `
            <div style="font-weight:800; font-size:1.1em; color:#991b1b; margin-bottom:6px;">
                è¾“å…¥æœ‰è¯¯
            </div>
            <div style="font-size:0.9em; color:#555; text-align:center;">${message}</div>
        `;
    }

    function resizeCanvas() {
        const rect = dom.canvas.getBoundingClientRect();
        const width = rect.width > 0 ? rect.width : CANVAS_BASE.width;
        const height = Math.round(width * CANVAS_ASPECT);
        const dpr = window.devicePixelRatio || 1;

        dom.canvas.style.height = `${height}px`;
        dom.canvas.width = Math.round(width * dpr);
        dom.canvas.height = Math.round(height * dpr);

        const ctx = dom.canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        canvasState.width = width;
        canvasState.height = height;
        canvasState.dpr = dpr;
    }

    function handleResize() {
        resizeCanvas();
        if (dom.newStemLen.value === "") {
            drawGridOnly();
            return;
        }
        calculate();
    }

    function init() {
        applyInputRules();
        resizeCanvas();
        window.addEventListener('resize', handleResize);

        myProducts.forEach((p, i) => {
            const opt = document.createElement('option');
            opt.text = p.name;
            opt.value = i;
            if(p.value === 'none' && i !== 0) opt.disabled = true; 
            dom.select.add(opt);
        });

        dom.select.addEventListener('change', onSelect);
        dom.inputs.forEach(el => el.addEventListener('input', calculate));
        
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæœ‰æ•ˆäº§å“ (Index 1)
        dom.select.value = 1; 
        dom.select.dispatchEvent(new Event('change'));
    }

    function onSelect(e) {
        const idx = e.target.value;
        const p = myProducts[idx];

        if (!p || p.value === 'none') {
            resetUI();
            return;
        }

        if (p.value === 'custom') {
            dom.specDetail.style.display = 'none';
            toggleLock(false);
            dom.newStemLen.value = 100;
            dom.newStemAng.value = -6;
            dom.newReach.value = 75;
            dom.newRise.value = 8;
        } else {
            dom.specDetail.style.display = 'block';
            // æ˜¾ç¤º Rise ä¿¡æ¯
            dom.specText.innerHTML = `Reach: ${p.reach}mm | Angle: ${p.stemAng}Â° | <span style="color:#059669">Rise: +${p.rise}mm</span>`;
            toggleLock(true);
            dom.newStemLen.value = p.stemLen;
            dom.newStemAng.value = p.stemAng; 
            dom.newReach.value = p.reach;
            dom.newRise.value = p.rise;
        }
        calculate();
    }

    function toggleLock(isLocked) {
        const addClass = isLocked ? 'locked-input' : 'editable-input';
        const remClass = isLocked ? 'editable-input' : 'locked-input';
        const tagText = isLocked ? 'å›ºå®š' : 'è‡ªå®šä¹‰';
        const tagClass = isLocked ? 'tag-fix' : 'tag-edit';

        ['newStemLen', 'newStemAng', 'newReach'].forEach(id => {
            const el = document.getElementById(id);
            el.readOnly = isLocked;
            el.className = addClass;
        });
        
        Object.values(dom.tags).forEach(t => {
            t.innerText = tagText;
            t.className = `tag ${tagClass}`;
        });
    }

    function resetUI() {
        dom.newStemLen.value = "";
        dom.specDetail.style.display = 'none';
        dom.report.style.display = 'none';
        clearValidation();
        drawGridOnly();
    }

    function calculate() {
        if (dom.newStemLen.value === "") {
            dom.report.style.display = 'none';
            drawGridOnly();
            return;
        }
        const errors = validateInputs();
        if (errors.length) {
            showValidationError(errors[0]);
            return;
        }

        // ã€ä¿®æ­£ã€‘ Old è§’åº¦ç›´æ¥è¯»å–ï¼Œä¸å¼ºåˆ¶ Math.absã€‚å…è®¸æ­£è´Ÿè¾“å…¥ã€‚
        // é»˜è®¤ HTML value è®¾ä¸º -6
        const rawOldAng = parseFloat(document.getElementById('oldStemAng').value) || -6;
        
        // New è§’åº¦ (è‹¥æ˜¯å“ç‰Œè§„æ ¼åˆ™ä¸ºå›ºå®šè´Ÿæ•°ï¼Œè‡ªå®šä¹‰åˆ™è·Ÿéšè¾“å…¥)
        const rawNewAng = parseFloat(dom.newStemAng.value) || 0;
        const newRise = parseFloat(dom.newRise.value) || 0;

        const data = {
            hta: parseFloat(document.getElementById('hta').value) || 73,
            old: {
                spacer: parseFloat(document.getElementById('oldSpacer').value) || 0,
                len: parseFloat(document.getElementById('oldStemLen').value) || 100,
                ang: rawOldAng, // ç›´æ¥ä½¿ç”¨è¾“å…¥å€¼ (ä¾‹å¦‚ -6 æˆ– 6)
                reach: parseFloat(document.getElementById('oldReach').value) || 80,
                drop: 125,
                rise: 0 
            },
            new: {
                spacer: parseFloat(dom.newSpacer.value) || 0,
                len: parseFloat(dom.newStemLen.value),
                ang: rawNewAng, 
                reach: parseFloat(dom.newReach.value),
                drop: FIX_DROP,
                rise: newRise 
            }
        };

        const p1 = getGeo(data.old.spacer, data.old.len, data.old.ang, data.old.reach, data.old.drop, data.old.rise, data.hta);
        const p2 = getGeo(data.new.spacer, data.new.len, data.new.ang, data.new.reach, data.new.drop, data.new.rise, data.hta);

        renderReport(p2.x - p1.x, p2.y - p1.y, data.new.spacer - data.old.spacer);
        draw(p1, p2, data.hta);
    }

    function getGeo(spacer, len, ang, reach, drop, rise, hta) {
        const rad = Math.PI / 180;
        const htaRad = hta * rad;
        
        const spX = -spacer * Math.cos(htaRad);
        const spY = spacer * Math.sin(htaRad);
        
        const stemAbsAng = ((hta - 90) + ang) * rad;
        const stX = len * Math.cos(stemAbsAng);
        const stY = len * Math.sin(stemAbsAng);
        
        return {
            x: spX + stX + reach,
            y: spY + stY + rise, 
            spX, spY, stX, stY, drop, rise
        };
    }

    function renderReport(dR, dS, dSpacer) {
        dom.report.style.display = 'block';
        let status = { color: 'green', title: 'âœ… å‡ ä½•åŒ¹é…è‰¯å¥½', class: 'alert-success' };
        let msg = "";

        if (dSpacer > 5) {
            status = { color: 'red', title: 'ğŸ›‘ è­¦å‘Šï¼šå«åœˆä¸è¶³', class: 'alert-danger' };
            msg = `æ³¨æ„ï¼šæ‚¨åœ¨æ¨¡æ‹Ÿä¸­å¢åŠ äº† <b>${dSpacer}mm</b> å«åœˆã€‚è¯·åŠ¡å¿…æ£€æŸ¥å‰å‰èˆµç®¡æ˜¯å¦é¢„ç•™äº†è¶³å¤Ÿé•¿åº¦ã€‚`;
        } else if (dS < -20 || dR > 15) {
            status = { color: 'orange', title: 'âš ï¸ å§¿æ€å˜åŒ–è¾ƒæ¿€è¿›', class: 'alert-warning' };
            msg = `æ‚¨çš„éª‘è¡Œå§¿æ€å°†å‘ç”Ÿè¾ƒå¤§æ”¹å˜ï¼ˆæ›´ä½æˆ–æ›´å‰ä¼¸ï¼‰ï¼Œè¯·ç¡®è®¤æ ¸å¿ƒåŠ›é‡å’ŒæŸ”éŸ§æ€§æ˜¯å¦è¶³å¤Ÿã€‚`;
        }

        const reachText = dR >= 0 ? "å‰ä¼¸ (Longer)" : "ç¼©çŸ­ (Shorter)";
        const reachIcon = dR >= 0 ? "â®•" : "â¬…";
        
        const stackText = dS >= 0 ? "å‡é«˜ (Higher)" : "é™ä½ (Lower)";
        const stackIcon = dS >= 0 ? "â¬†" : "â¬‡";

        dom.report.className = `alert-box ${status.class}`;
        dom.reportContent.innerHTML = `
            <div style="font-weight:800; font-size:1.2em; color:${status.color === 'red' ? '#991b1b' : (status.color==='orange'?'#9a3412':'#065f46')}; margin-bottom:10px;">
                ${status.title}
            </div>
            <div class="metric-row">
                <div>
                    <div class="metric-val">
                        <span class="metric-icon">${reachIcon}</span> ${Math.abs(dR).toFixed(1)}
                    </div>
                    <div class="metric-lbl">${reachText}</div>
                </div>
                <div style="width:1px; background:#ccc;"></div>
                <div>
                    <div class="metric-val">
                        <span class="metric-icon">${stackIcon}</span> ${Math.abs(dS).toFixed(1)}
                    </div>
                    <div class="metric-lbl">${stackText}</div>
                </div>
            </div>
            <div style="font-size:0.9em; color:#555; text-align:center;">${msg}</div>
        `;
    }

    // --- æ–°å¢è¾…åŠ©å‡½æ•°ï¼šç»˜åˆ¶åŸºå‡†å‚è€ƒç³» ---
    function drawReference(ctx, hta) {
        const rad = Math.PI / 180;
        
        // ã€ä¿®æ­£1ã€‘0åº¦åŸºå‡†çº¿ï¼ˆå‚ç›´äºå¤´ç®¡ï¼‰ï¼šåº”è¯¥æ˜¯ (90 - hta)ã€‚
        // ä¾‹å¦‚ HTA=73åº¦ï¼Œ90-73 = 17åº¦ (æŒ‡å‘å³ä¸Šæ–¹)
        const zeroAng = (90 - hta) * rad; 
        
        // ã€ä¿®æ­£2ã€‘å¤´ç®¡ç»˜åˆ¶æ–¹å‘ï¼šå‚ç›´çº¿å†é¡ºæ—¶é’ˆæ—‹è½¬90åº¦ (å³å‘ä¸‹è¿›å…¥è½¦æ¶çš„æ–¹å‘)
        // è§’åº¦ = 17 - 90 = -73åº¦ (æŒ‡å‘å³ä¸‹æ–¹ï¼Œç¬¦åˆçœŸå®å‰å‰å‡ ä½•)
        const steererAng = zeroAng - (90 * rad);

        const refLen = 220; // å»¶é•¿å‚è€ƒçº¿é•¿åº¦ï¼Œæ–¹ä¾¿çœ‹æ¸…
        const steererLen = 80; // å¤´ç®¡ç»˜åˆ¶é•¿åº¦

        ctx.save();
        
        // 1. ç»˜åˆ¶å¤´ç®¡ (Steerer/SpaceråŒºåŸŸ) - æ·±ç°è‰²å®çº¿
        // è¿™ä»£è¡¨æŠŠç«‹ä¸‹æ–¹çš„å«åœˆ/å¤´ç®¡éƒ¨åˆ†
        ctx.strokeStyle = "#94a3b8"; 
        ctx.lineWidth = 14;
        ctx.lineCap = "butt"; 
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(Math.cos(steererAng) * steererLen, Math.sin(steererAng) * steererLen);
        ctx.stroke();

        // 2. ç»˜åˆ¶ 0åº¦åŸºå‡†çº¿ (å‚ç›´äºå¤´ç®¡) - çº¢è‰²è™šçº¿
        ctx.strokeStyle = "#ef4444"; 
        ctx.lineWidth = 1;
        ctx.setLineDash([6, 3]); 
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(Math.cos(zeroAng) * refLen, Math.sin(zeroAng) * refLen);
        ctx.stroke();

        // 3. ç»˜åˆ¶ç›´è§’æ ‡è®°
        const size = 12;
        ctx.strokeStyle = "#cbd5e1";
        ctx.setLineDash([]); 
        ctx.lineWidth = 1;
        ctx.beginPath();
        
        // è®¡ç®—ç›´è§’ç¬¦å·çš„é¡¶ç‚¹
        const p1x = Math.cos(zeroAng) * size;
        const p1y = Math.sin(zeroAng) * size;
        const p2x = Math.cos(steererAng) * size;
        const p2y = Math.sin(steererAng) * size;
        
        ctx.moveTo(p1x, p1y);
        ctx.lineTo(p1x + p2x, p1y + p2y); 
        ctx.lineTo(p2x, p2y);
        ctx.stroke();

        // 4. æ–‡å­—æ ‡æ³¨ (+Angle / -Angle)
        ctx.save();
        // ä¸´æ—¶å–æ¶ˆYè½´ç¿»è½¬ï¼Œä»¥ç»˜åˆ¶æ­£å‘æ–‡å­—
        ctx.scale(1, -1); 
        
        ctx.font = "bold 12px Inter, sans-serif";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";

        const textDist = 140;
        const textOffset = 10 * rad; // æ–‡å­—ä¸çº¿çš„å¤¹è§’åç§»

        // è®¡ç®—æ–‡å­—ä½ç½® (æ³¨æ„ï¼šå› ä¸ºscaleç¿»è½¬äº†Yï¼Œè¿™é‡Œsinå–å)
        // +Angle åŒºåŸŸ (çº¿ä¹‹ä¸Š)
        const posX = Math.cos(zeroAng + textOffset) * textDist;
        const posY = -Math.sin(zeroAng + textOffset) * textDist;
        
        // -Angle åŒºåŸŸ (çº¿ä¹‹ä¸‹)
        const negX = Math.cos(zeroAng - textOffset) * textDist;
        const negY = -Math.sin(zeroAng - textOffset) * textDist;

        // ç»˜åˆ¶ "+Angle"
        ctx.fillStyle = "#ef4444";
        ctx.fillText("+Angle", posX, posY);
        
        // ç»˜åˆ¶ "-Angle"
        ctx.fillStyle = "#64748b";
        ctx.fillText("-Angle", negX, negY);

        // ç»˜åˆ¶ "90Â°"
        ctx.fillStyle = "#94a3b8";
        ctx.font = "10px Inter";
        ctx.textAlign = "center";
        // æ”¾åœ¨ç›´è§’æ ‡è®°æ—è¾¹
        ctx.fillText("90Â°", (p1x+p2x)*0.9, -(p1y+p2y)*0.9);

        ctx.restore(); 
        ctx.restore(); 
    }

    // --- ä¿®æ”¹åçš„ä¸»ç»˜å›¾å‡½æ•° ---
    function draw(p1, p2, hta) {
        const ctx = dom.canvas.getContext('2d');
        const w = canvasState.width;
        const h = canvasState.height;
        ctx.clearRect(0,0,w,h);

        drawGrid(ctx, w, h);

        const widthScale = w / CANVAS_BASE.width;
        const heightScale = h / CANVAS_BASE.height;
        const scale = CANVAS_BASE.scale * widthScale; 
        const originX = CANVAS_BASE.originX * widthScale; 
        const originY = CANVAS_BASE.originY * heightScale; 

        // åœ°é¢ (ç®€å•çº¿æ¡)
        ctx.strokeStyle = "#e2e8f0";
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(0, originY); ctx.lineTo(w, originY); ctx.stroke();

        // === æ ¸å¿ƒä¿®æ”¹ï¼šç»Ÿä¸€åæ ‡ç³» ===
        ctx.save();
        ctx.translate(originX, originY);
        ctx.scale(scale, -scale); // Yè½´å‘ä¸Šä¸ºæ­£ï¼Œç¬¦åˆå‡ ä½•ç›´è§‰

        // 1. å…ˆç”»åŸºå‡†å‚è€ƒç³» (åœ¨æœ€åº•å±‚)
        drawReference(ctx, hta);

        // 2. å®šä¹‰å†…éƒ¨ç»˜åˆ¶é›¶ä»¶å‡½æ•° (é€»è¾‘ä¸å˜ï¼Œä½†åœ¨æ–°åæ ‡ç³»ä¸‹ç®€åŒ–äº†)
        function drawBikePart(p, color, isGhost) {
            ctx.save();
            // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦å† translate/scale äº†ï¼Œå› ä¸ºå¤–éƒ¨å·²ç»åšè¿‡
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = isGhost ? 1 : 2;
            
            if(isGhost) {
                ctx.setLineDash([5, 3]);
                ctx.globalAlpha = 0.4;
            } else {
                ctx.setLineDash([]);
                ctx.globalAlpha = 1.0;
                ctx.shadowColor = "rgba(0,0,0,0.2)";
                ctx.shadowBlur = 10;
                // ä¿®æ­£é˜´å½±æ–¹å‘ (å› ä¸ºscaleç¿»è½¬äº†)
                ctx.shadowOffsetY = 5; 
            }

            // å«åœˆ
            ctx.beginPath();
            ctx.moveTo(0, 0); ctx.lineTo(p.spX, p.spY);
            ctx.lineCap = "butt"; ctx.lineWidth = 10; ctx.stroke();

            // æŠŠç«‹
            ctx.beginPath();
            ctx.moveTo(p.spX, p.spY); ctx.lineTo(p.spX + p.stX, p.spY + p.stY);
            ctx.lineWidth = 8; ctx.stroke();

            // å¼¯æŠŠå½¢çŠ¶
            const barX = p.x;
            const barY = p.y; 
            const dropVal = p.drop;
            
            ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.lineJoin = "round";
            
            ctx.beginPath();
            ctx.moveTo(p.spX + p.stX, p.spY + p.stY);
            ctx.lineTo(barX, barY); 
            
            // ä¸‹æŠŠä½
            const cp1x = barX + 30; const cp1y = barY;
            const cp2x = barX + 30; const cp2y = barY - dropVal;
            const endX = barX - 10; const endY = barY - dropVal;

            ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, endX, endY);
            ctx.stroke();

            // æ ‡æ³¨ç‚¹ (æ‰‹å˜ä½ç½®)
            ctx.fillStyle = isGhost ? "#94a3b8" : "#fff";
            ctx.beginPath();
            ctx.arc(barX, barY, isGhost ? 2 : 3, 0, Math.PI * 2);
            ctx.fill();
            if(!isGhost) ctx.stroke();

            ctx.restore();
        }

        drawBikePart(p1, "#64748b", true); 
        drawBikePart(p2, "#0f172a", false); 

        ctx.restore();
    }

    function drawGrid(ctx, w, h) {
        ctx.strokeStyle = "#f1f5f9";
        ctx.lineWidth = 1;
        const step = Math.max(18, Math.round(25 * (w / CANVAS_BASE.width))); 
        
        ctx.beginPath();
        for (let x = 0; x < w; x += step) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
        for (let y = 0; y < h; y += step) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
        ctx.stroke();
    }

    function drawGridOnly() {
        const ctx = dom.canvas.getContext('2d');
        ctx.clearRect(0,0,canvasState.width,canvasState.height);
        drawGrid(ctx, canvasState.width, canvasState.height);
    }

    init();
</script>
</body>
</html>
