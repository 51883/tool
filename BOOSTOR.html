<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BOOSTOR Pro Geometry Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* === å…¨å±€æ ·å¼ === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --primary: #0f172a; --accent: #3b82f6; --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --text-sub: #64748b; --border: #e2e8f0; --radius-input: 10px; --radius-card: 16px; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); padding: 30px 15px; line-height: 1.6; }
        .container { max-width: 960px; margin: 0 auto; }
        h1 { text-align: center; font-weight: 800; font-size: 2rem; color: var(--primary); margin-bottom: 5px; }
        .sub-header { text-align: center; color: var(--text-sub); margin-bottom: 40px; font-size: 0.95rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media(max-width: 768px) { .grid-2 { grid-template-columns: 1fr; gap: 20px; } body { padding: 20px 10px; } }
        .panel { background: var(--bg-card); padding: 25px; border-radius: var(--radius-card); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .panel-new { border-top: 4px solid var(--primary); }
        .panel-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .input-group { margin-bottom: 18px; width: 100%; }
        label { display: block; font-size: 0.75rem; text-transform: uppercase; color: var(--text-sub); font-weight: 600; margin-bottom: 6px; }
        input, select { width: 100%; padding: 12px 15px; font-size: 0.95rem; font-weight: 600; color: var(--primary); background: #fff; border: 1px solid var(--border); border-radius: var(--radius-input); }
        .locked-input { background-color: #f8fafc; color: #94a3b8; border-color: #f1f5f9; cursor: default; }
        .spacer-input { border-color: #f59e0b; color: #b45309; background-color: #fffbeb; }
        .tag { display: inline-block; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        .tag-fix { background: #e2e8f0; color: #64748b; } .tag-edit { background: #dbeafe; color: #1e40af; }
        .canvas-container {display: none !important; position: relative; background: #fff; border-radius: var(--radius-card); border: 1px solid var(--border); padding: 10px; margin-top: 30px; overflow: hidden; display: none; }
        canvas { width: 100%; height: auto; display: block; }
        .alert-box { background: #fff; border-radius: var(--radius-card); padding: 25px; margin-top: 30px; display: none; border-left: 5px solid #ccc; }
        .alert-success { border-color: #10b981; background: #ecfdf5; } .alert-danger { border-color: #ef4444; background: #fef2f2; } .alert-warning { border-color: #f59e0b; background: #fffbeb; }
        .metric-row { display: flex; justify-content: space-around; text-align: center; margin: 15px 0; padding: 20px 0; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .metric-val { font-size: 1.6rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 5px; }
        .metric-lbl { font-size: 0.8rem; color: var(--text-sub); text-transform: uppercase; margin-top: 5px; font-weight: 600;}
        .explain-box { background: rgba(255,255,255,0.8); border-radius: 8px; padding: 15px; margin-top: 20px; border: 1px dashed #cbd5e1; font-size: 0.9rem; color: #475569; }
        .explain-title { font-weight: 700; margin-bottom: 8px; color: #334155; display: flex; align-items: center; gap: 6px; }
        .explain-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width: 600px) { .explain-grid { grid-template-columns: 1fr; gap: 15px; } }
        .explain-list { list-style: none; padding: 0; margin: 0; }
        .explain-list li { margin-bottom: 6px; padding-left: 10px; border-left: 2px solid #e2e8f0; font-size: 0.85em; }
        
        /* æ ¸å¿ƒä¿®æ”¹ï¼šè¯¦ç»†è§£ææ ·å¼ */
        details.math-details { margin-top: 20px; background: #f8fafc; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
        details.math-details summary { padding: 15px; font-weight: 600; cursor: pointer; color: #334155; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; }
        details.math-details summary::after { content: "æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹ â–¼"; font-size: 0.8em; color: #64748b; }
        details[open].math-details summary::after { content: "æ”¶èµ· â–²"; }
        .math-content { padding: 20px; font-size: 0.9rem; color: #334155; line-height: 1.8; background: #fff; }
        .math-block { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #e2e8f0; }
        .math-block:last-child { border: none; margin: 0; padding: 0; }
        .math-h { font-weight: 700; color: #0f172a; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .math-desc { margin-bottom: 8px; color: #475569; }
        .math-eq { background: #f1f5f9; padding: 8px 12px; border-radius: 6px; font-family: 'Menlo', monospace; font-size: 0.85em; color: #0f172a; margin: 6px 0; border-left: 3px solid #3b82f6; }
        .math-note { font-size: 0.85em; color: #64748b; margin-top: 4px; font-style: italic; }
        .highlight-red { color: #ef4444; font-weight: 700; }
        .highlight-green { color: #10b981; font-weight: 700; }
        
        .legend { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; border: 1px solid #eee; font-size: 0.8rem; pointer-events: none; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
    </style>
</head>
<body>

<div class="container">
    <h1>BOOSTOR Pro</h1>
    <div class="sub-header">ä¸“ä¸šçº§ä¸€ä½“æŠŠå®‰è£…ä¸å‡ ä½•åˆ†æç³»ç»Ÿ (V5.6 Final)</div>

    <div class="grid-2">
        <div class="panel">
            <div class="panel-title">ğŸš² <span>åŸè½¦è®¾å®š (Old)</span></div>
            <div class="input-group"><label>Reach</label><input type="number" id="oldReach" value="80"></div>
            <div class="grid-2" style="margin-bottom:0; gap:15px;">
                <div class="input-group"><label>æŠŠç«‹é•¿åº¦</label><input type="number" id="oldStemLen" value="100"></div>
                <div class="input-group"><label>æŠŠç«‹è§’åº¦ (Â°)</label><input type="number" id="oldStemAng" value="-6"></div>
            </div>
            <div class="input-group"><label>å«åœˆé«˜åº¦ (Spacer)</label><input type="number" id="oldSpacer" value="20"></div>
            <div class="input-group"><label>å¤´ç®¡è§’åº¦ (HTA)</label><input type="number" id="hta" value="73"></div>
        </div>

        <div class="panel panel-new">
            <div class="panel-title">ğŸ›’ <span>ç›®æ ‡è®¾å®š (New)</span></div>
            <div class="input-group"><label>é€‰æ‹©äº§å“è§„æ ¼</label><select id="productSelect"></select></div>
            <div id="specDetail" style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:20px; display:none;">
                <div style="font-size:0.85em; color:#64748b; margin-bottom:5px;">è§„æ ¼è¯¦æƒ…</div>
                <div id="specText" style="font-weight:700; color:#0f172a;"></div>
            </div>
            <div class="grid-2" style="margin-bottom:0; gap:15px;">
                <div class="input-group"><label>æ–°æŠŠç«‹é•¿åº¦ <span id="tagLen" class="tag tag-fix">å›ºå®š</span></label><input type="number" id="newStemLen" class="locked-input" readonly></div>
                <div class="input-group"><label>æ–°æŠŠç«‹è§’åº¦ (Â°) <span id="tagAng" class="tag tag-fix">å›ºå®š</span></label><input type="number" id="newStemAng" class="locked-input" readonly></div>
            </div>
            <div class="input-group"><label>æ–°è½¦æŠŠ Reach <span id="tagReach" class="tag tag-fix">å›ºå®š</span></label><input type="number" id="newReach" class="locked-input" readonly></div>
            <input type="hidden" id="newRise">
            <div class="input-group" style="margin-top:20px;">
                <label style="color:var(--highlight);">ğŸ”§ æ¨¡æ‹Ÿè°ƒæ•´ï¼šå«åœˆé«˜åº¦ (mm)</label>
                <input type="number" id="newSpacer" value="20" class="spacer-input">
            </div>
        </div>
    </div>

    <div id="reportCard" class="alert-box">
        <div id="reportContent"></div>
    </div>

    <div class="canvas-container">
        <canvas id="simCanvas" width="900" height="500"></canvas>
        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:#cbd5e1; border:1px dashed #64748b;"></div> åŸè®¾ç½®</div>
            <div class="legend-item"><div class="dot" style="background:#0f172a;"></div> æ–°è®¾ç½®</div>
        </div>
    </div>
</div>

<script>
    // === åŸºç¡€é…ç½® ===
    const FIX_REACH=70, FIX_DROP=125, FIX_RISE=8;
    const CANVAS_BASE = { width: 900, height: 500, scale: 2.5, originX: 200, originY: 400 };
    const canvasState = { width: 900, height: 500 };

    const dom = {
        select: document.getElementById('productSelect'),
        inputs: document.querySelectorAll('input'),
        canvas: document.getElementById('simCanvas'),
        report: document.getElementById('reportCard'),
        reportContent: document.getElementById('reportContent'),
        specDetail: document.getElementById('specDetail'),
        specText: document.getElementById('specText'),
        // ç»‘å®šå¸¸ç”¨è¾“å…¥æ¡†
        newStemLen: document.getElementById('newStemLen'),
        newStemAng: document.getElementById('newStemAng'),
        newReach: document.getElementById('newReach'),
        newRise: document.getElementById('newRise'),
        newSpacer: document.getElementById('newSpacer'),
        tags: { len: document.getElementById('tagLen'), ang: document.getElementById('tagAng'), reach: document.getElementById('tagReach') }
    };

    const myProducts = [
        { name: "è¯·é€‰æ‹©è§„æ ¼...", value: "none" }, 
        { name: "90mm (14.8Â°)", stemLen: 90, stemAng: 14.8, reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "100mm (11.4Â°)", stemLen: 100, stemAng: 11.4, reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "110mm (9.2Â°)",  stemLen: 110, stemAng: 9.2,  reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "120mm (7.2Â°)",  stemLen: 120, stemAng: 7.2,  reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "130mm (5.56Â°)", stemLen: 130, stemAng: 5.56, reach: FIX_REACH, drop: FIX_DROP, rise: FIX_RISE },
        { name: "---", value: "none" },
        { name: "ğŸ› ï¸ è‡ªå®šä¹‰æ¨¡å¼", value: "custom", stemLen: 100, stemAng: -6, reach: 75, drop: 125, rise: 8 }
    ];

    function init() {
        resizeCanvas();
        window.addEventListener('resize', () => { resizeCanvas(); calculate(); });
        myProducts.forEach((p, i) => {
            const opt = document.createElement('option');
            opt.text = p.name; opt.value = i;
            if(p.value==='none' && i!==0) opt.disabled=true;
            dom.select.add(opt);
        });
        dom.select.addEventListener('change', onSelect);
        dom.inputs.forEach(el => el.addEventListener('input', calculate));
        dom.select.value = 1; dom.select.dispatchEvent(new Event('change'));
    }

    function onSelect(e) {
        const idx = e.target.value; const p = myProducts[idx];
        if(!p || p.value==='none') return;
        const isCustom = (p.value==='custom');
        toggleLock(!isCustom);
        if(isCustom) {
            dom.specDetail.style.display='none';
            dom.newStemLen.value=100; dom.newStemAng.value=-6; dom.newReach.value=75; dom.newRise.value=8;
        } else {
            dom.specDetail.style.display='block';
            dom.specText.innerHTML = `Reach: ${p.reach}mm | Angle: ${p.stemAng>0?'+':''}${p.stemAng}Â° | <span style="color:#059669">Rise: +${p.rise}mm</span>`;
            dom.newStemLen.value=p.stemLen; dom.newStemAng.value=p.stemAng; dom.newReach.value=p.reach; dom.newRise.value=p.rise;
        }
        calculate();
    }

    function toggleLock(isLocked) {
        ['newStemLen','newStemAng','newReach'].forEach(id=>{
            const el=document.getElementById(id);
            el.readOnly=isLocked; el.className=isLocked?'locked-input':'editable-input';
        });
        const txt = isLocked?'å›ºå®š':'è‡ªå®šä¹‰'; const cls = isLocked?'tag-fix':'tag-edit';
        Object.values(dom.tags).forEach(t=>{ t.innerText=txt; t.className=`tag ${cls}`; });
    }

    function calculate() {
        if(dom.newStemLen.value==="") return;
        const hta = parseFloat(document.getElementById('hta').value)||73;
        
        const data = {
            hta: hta,
            old: {
                spacer: parseFloat(document.getElementById('oldSpacer').value)||0,
                len: parseFloat(document.getElementById('oldStemLen').value)||100,
                ang: parseFloat(document.getElementById('oldStemAng').value)||-6,
                reach: parseFloat(document.getElementById('oldReach').value)||80,
                drop: 125, rise: 0 
            },
            new: {
                spacer: parseFloat(dom.newSpacer.value)||0,
                len: parseFloat(dom.newStemLen.value),
                ang: parseFloat(dom.newStemAng.value), 
                reach: parseFloat(dom.newReach.value),
                drop: FIX_DROP, rise: parseFloat(dom.newRise.value)||0 
            }
        };

        const p1 = getGeo(data.old, hta);
        const p2 = getGeo(data.new, hta);

        // å½’å› åˆ†æ
        const reachComps = {
            stem: p2.stX - p1.stX,
            bar: data.new.reach - data.old.reach
        };
        const stackComps = {
            spacer: p2.spY - p1.spY,
            stem: p2.stY - p1.stY,
            rise: data.new.rise - data.old.rise
        };

        renderReport(p2.x - p1.x, p2.y - p1.y, data.new.spacer - data.old.spacer, reachComps, stackComps, data);
        draw(p1, p2, hta);
    }

    function getGeo(d, hta) {
        const rad = Math.PI / 180;
        const htaRad = hta * rad;
        const spX = -d.spacer * Math.cos(htaRad);
        const spY = d.spacer * Math.sin(htaRad);
        
        const stemAbsAng = ((hta - 90) + d.ang) * rad;
        const stX = d.len * Math.cos(stemAbsAng);
        const stY = d.len * Math.sin(stemAbsAng);
        
        return {
            x: spX + stX + d.reach,
            y: spY + stY + d.rise, 
            spX, spY, stX, stY, drop: d.drop, rise: d.rise
        };
    }

    function renderReport(dR, dS, dSpacer, rComps, sComps, data) {
        dom.report.style.display = 'block';
        const reachDiff = parseFloat(dR.toFixed(1));
        const stackDiff = parseFloat(dS.toFixed(1));
        const sign = (n) => n > 0 ? `+${n.toFixed(1)}` : n.toFixed(1);

        let status = { color: 'green', title: 'âœ… å‡ ä½•åŒ¹é…è‰¯å¥½', class: 'alert-success' };
        let msg = "";
        if (dSpacer > 5) {
            status = { color: 'red', title: 'ğŸ›‘ è­¦å‘Šï¼šå«åœˆä¸è¶³', class: 'alert-danger' };
            msg = `æ³¨æ„ï¼šæ¨¡æ‹Ÿå¢åŠ äº† <b>${dSpacer}mm</b> å«åœˆï¼Œè¯·æ£€æŸ¥å‰å‰é¢„ç•™é•¿åº¦ã€‚`;
        } else if (stackDiff < -20 || reachDiff > 15) {
            status = { color: 'orange', title: 'âš ï¸ å§¿æ€å˜åŒ–è¾ƒæ¿€è¿›', class: 'alert-warning' };
            msg = `å§¿æ€å˜åŒ–è¾ƒå¤§ï¼Œè¯·ç¡®è®¤èº«ä½“æŸ”éŸ§æ€§æ˜¯å¦å…è®¸ã€‚`;
        }

        const mathHtml = generateMathDetails(data, reachDiff, stackDiff);

        dom.report.className = `alert-box ${status.class}`;
        dom.reportContent.innerHTML = `
            <div style="font-weight:800; font-size:1.2em; color:${status.color==='red'?'#991b1b':(status.color==='orange'?'#9a3412':'#065f46')}; margin-bottom:10px;">
                ${status.title}
            </div>
            <div class="metric-row">
                <div>
                    <div class="metric-val"><span class="metric-icon">${reachDiff>=0?"â®•":"â¬…"}</span> ${Math.abs(reachDiff)}</div>
                    <div class="metric-lbl">${reachDiff>=0?"å‰ä¼¸ (Longer)":"ç¼©çŸ­ (Shorter)"}</div>
                </div>
                <div style="width:1px; background:#ccc;"></div>
                <div>
                    <div class="metric-val"><span class="metric-icon">${stackDiff>=0?"â¬†":"â¬‡"}</span> ${Math.abs(stackDiff)}</div>
                    <div class="metric-lbl">${stackDiff>=0?"å‡é«˜ (Higher)":"é™ä½ (Lower)"}</div>
                </div>
            </div>
            <div style="font-size:0.9em; color:#555; text-align:center;">${msg}</div>
            
            <div class="explain-box">
                <div class="explain-title"><span style="font-size:1.2em">ğŸ’¡</span> å˜åŒ–å½’å› ç®€æ</div>
                <div class="explain-grid">
                    <div>
                        <h4>Reach ç»„æˆ</h4>
                        <ul class="explain-list">
                            <li>è½¦æŠŠç‰©ç†ç¼©çŸ­: <b>${sign(rComps.bar)}mm</b></li>
                            <li>æŠŠç«‹è§’åº¦è¡¥å¿: <b>${sign(rComps.stem)}mm</b></li>
                            <li style="border:none; color:#94a3b8; font-size:0.8em; margin-top:4px;">${sign(rComps.bar)} + ${sign(rComps.stem)} â‰ˆ ${sign(reachDiff)}</li>
                        </ul>
                    </div>
                    <div>
                        <h4>Stack ç»„æˆ</h4>
                        <ul class="explain-list">
                            <li>å«åœˆé«˜åº¦è°ƒæ•´: <b>${sign(sComps.spacer)}mm</b></li>
                            <li>æŠŠç«‹è§’åº¦æŠ¬å‡: <b>${sign(sComps.stem)}mm</b></li>
                            <li>è½¦æŠŠè‡ªå¸¦ Rise: <b>${sign(sComps.rise)}mm</b></li>
                        </ul>
                    </div>
                </div>
            </div>
            ${mathHtml}
        `;
    }

    function generateMathDetails(d, rDiff, sDiff) {
        const rad = Math.PI/180;
        const htaOffset = d.hta - 90; // e.g., 73 - 90 = -17
        
        const oldAbs = htaOffset + d.old.ang;
        const newAbs = htaOffset + d.new.ang;
        
        const oldProj = d.old.len * Math.cos(oldAbs * rad);
        const newProj = d.new.len * Math.cos(newAbs * rad);
        
        const oldStemY = d.old.len * Math.sin(oldAbs * rad);
        const newStemY = d.new.len * Math.sin(newAbs * rad);

        const f = (n) => n.toFixed(1);
        const f2 = (n) => n.toFixed(2);

        return `
            <details class="math-details">
                <summary>è¯¦ç»†æ•°å­¦è§£æï¼šä¸ºä½•å¦‚æ­¤è®¡ç®—ï¼Ÿ</summary>
                <div class="math-content">
                    
                    <div class="math-block">
                        <div class="math-h">1. åæ ‡ç³»åŸºå‡†</div>
                        <div class="math-desc">
                            æ‰€æœ‰çš„è®¡ç®—åŸºäºå¤´ç®¡è§’åº¦ (HTA ${d.hta}Â°)ã€‚æˆ‘ä»¬å°†å‚ç›´äºåœ°é¢çš„çº¿å®šä¹‰ä¸º -90Â°ï¼Œé‚£ä¹ˆå‚ç›´äºå¤´ç®¡çš„çº¿å°±æ˜¯ ${f(htaOffset)}Â°ã€‚<br>
                            è¿™æ„å‘³ç€ï¼Œå¦‚æœæŠŠç«‹æ˜¯ <b>${f(htaOffset)}Â°</b>ï¼Œå®ƒå°±æ˜¯å®Œå…¨æ°´å¹³çš„ã€‚
                        </div>
                    </div>

                    <div class="math-block">
                        <div class="math-h">2. Reach è®¡ç®—ï¼ˆæ°´å¹³æ–¹å‘ï¼‰</div>
                        <div class="math-desc">
                            ä¸ºä»€ä¹ˆæŠŠç«‹é•¿åº¦ä¸€æ ·ï¼ŒReach å´å˜äº†ï¼Ÿå› ä¸ºè§’åº¦æ”¹å˜äº†æŠ•å½±é•¿åº¦ã€‚<br>
                            æƒ³è±¡ä¸€æ ¹æ£å­ï¼Œ<b>è¶Šå¹³ï¼Œå®ƒåœ¨åœ°é¢çš„å½±å­è¶Šé•¿ã€‚</b>
                        </div>
                        <div class="math-eq">æ—§æŠŠç«‹è§’åº¦ (${d.old.ang}Â°) â†’ ç»å¯¹è§’åº¦ ${f(oldAbs)}Â°</div>
                        <div class="math-desc">æ—§æŠ•å½±é•¿åº¦ = ${d.old.len} Ã— cos(${f(oldAbs)}Â°) = <b>${f2(oldProj)}mm</b></div>
                        
                        <div class="math-eq">æ–°æŠŠç«‹è§’åº¦ (${d.new.ang}Â°) â†’ ç»å¯¹è§’åº¦ ${f(newAbs)}Â°</div>
                        <div class="math-desc">æ–°æŠ•å½±é•¿åº¦ = ${d.new.len} Ã— cos(${f(newAbs)}Â°) = <b>${f2(newProj)}mm</b></div>
                        
                        <div class="math-note">
                            ç»“è®ºï¼šæ–°æŠŠç«‹æ¯”æ—§æŠŠç«‹â€œæ›´å¹³â€äº†ï¼Œæ‰€ä»¥æ°´å¹³å»¶ä¼¸å¢åŠ äº† 
                            <span class="highlight-green">+${f2(newProj - oldProj)}mm</span>ã€‚
                            è¿™éƒ¨åˆ†å¢åŠ æŠµæ¶ˆäº†è½¦æŠŠç‰©ç†ç¼©çŸ­çš„é‡ã€‚
                        </div>
                    </div>

                    <div class="math-block">
                        <div class="math-h">3. Stack è®¡ç®—ï¼ˆå‚ç›´æ–¹å‘ï¼‰</div>
                        <div class="math-desc">
                            é«˜åº¦å˜åŒ–ç”±ä¸‰éƒ¨åˆ†å åŠ è€Œæˆï¼š
                        </div>
                        <ul style="padding-left:20px; margin:5px 0;">
                            <li><b>å«åœˆå˜åŒ–:</b> ${f(d.new.spacer - d.old.spacer)} Ã— sin(${d.hta}Â°) â‰ˆ <b>${f((d.new.spacer - d.old.spacer)*Math.sin(d.hta*rad))}mm</b></li>
                            <li><b>Rise (æŠ¬å‡):</b> æ–°è½¦æŠŠè‡ªå¸¦äº† <b>+${d.new.rise}mm</b> çš„äºŒæ¬¡æŠ¬å‡ã€‚</li>
                            <li><b>æŠŠç«‹è§’åº¦:</b> è¿™æ˜¯æœ€å¤§çš„å˜é‡ã€‚æ—§æŠŠç«‹å‘ä¸‹å€¾æ–œå‰å®³ (sin${f(oldAbs)}Â°)ï¼Œæ–°æŠŠç«‹å‡ ä¹æ°´å¹³ (sin${f(newAbs)}Â°)ã€‚</li>
                        </ul>
                        <div class="math-eq">
                            æŠŠç«‹å‚ç›´æŠ¬å‡ = ${f(newStemY)} - (${f(oldStemY)}) = <b>+${f(newStemY - oldStemY)}mm</b>
                        </div>
                        <div class="math-note">
                            ç”±äºæ–°æŠŠç«‹ä¸å†åƒæ—§æŠŠç«‹é‚£æ ·â€œå¤§å¹…ä¸‹æ²‰â€ï¼Œè½¦å¤´é«˜åº¦è‡ªç„¶å°±æ˜¾è‘—å¢åŠ äº†ã€‚
                        </div>
                    </div>

                </div>
            </details>
        `;
    }

    // ç»˜å›¾å‡½æ•°ä¿æŒä¸å˜ï¼Œå‹ç¼©ä»¥èŠ‚çœç©ºé—´
    function resizeCanvas() {
        const rect = dom.canvas.getBoundingClientRect();
        const w = rect.width||CANVAS_BASE.width; const h = Math.round(w * (500/900));
        const dpr = window.devicePixelRatio||1;
        dom.canvas.style.height=`${h}px`; dom.canvas.width=Math.round(w*dpr); dom.canvas.height=Math.round(h*dpr);
        dom.canvas.getContext('2d').setTransform(dpr,0,0,dpr,0,0);
        canvasState.width=w; canvasState.height=h;
    }
    function draw(p1, p2, hta) {
        const ctx = dom.canvas.getContext('2d');
        const w=canvasState.width, h=canvasState.height;
        ctx.clearRect(0,0,w,h);
        
        ctx.strokeStyle="#f1f5f9"; ctx.lineWidth=1; ctx.beginPath();
        const step = Math.max(18, Math.round(25*(w/900))); 
        for(let x=0;x<w;x+=step){ctx.moveTo(x,0);ctx.lineTo(x,h);}
        for(let y=0;y<h;y+=step){ctx.moveTo(0,y);ctx.lineTo(w,y);}
        ctx.stroke();

        const ws = w/900; const sc = 2.5*ws; 
        const ox = 200*ws; const oy = 400*(h/500); 

        ctx.strokeStyle="#e2e8f0"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,oy); ctx.lineTo(w,oy); ctx.stroke();
        ctx.save(); ctx.translate(ox, oy); ctx.scale(sc, -sc); 

        drawRef(ctx, hta);
        drawPart(ctx, p1, "#64748b", true); 
        drawPart(ctx, p2, "#0f172a", false); 
        ctx.restore(); dom.canvas.parentElement.style.display='block';
    }
    function drawRef(ctx, hta) {
        const rad=Math.PI/180, zero=(90-hta)*rad, str=zero-(90*rad);
        ctx.save();
        ctx.strokeStyle="#94a3b8"; ctx.lineWidth=14; ctx.lineCap="butt"; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(str)*80,Math.sin(str)*80); ctx.stroke();
        ctx.strokeStyle="#ef4444"; ctx.lineWidth=1; ctx.setLineDash([6,3]); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(zero)*220,Math.sin(zero)*220); ctx.stroke();
        ctx.restore();
    }
    function drawPart(ctx, p, col, isG) {
        ctx.save();
        ctx.strokeStyle=col; ctx.fillStyle=col; ctx.lineWidth=isG?1:2;
        if(isG){ctx.setLineDash([5,3]); ctx.globalAlpha=0.4;}
        else{ctx.setLineDash([]); ctx.globalAlpha=1.0; ctx.shadowColor="rgba(0,0,0,0.2)"; ctx.shadowBlur=10; ctx.shadowOffsetY=5;}
        
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(p.spX,p.spY); ctx.lineCap="butt"; ctx.lineWidth=10; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.spX,p.spY); ctx.lineTo(p.spX+p.stX,p.spY+p.stY); ctx.lineWidth=8; ctx.stroke();
        
        const bx=p.x, by=p.y;
        ctx.lineWidth=5; ctx.lineCap="round"; ctx.lineJoin="round";
        ctx.beginPath(); ctx.moveTo(p.spX+p.stX,p.spY+p.stY); ctx.lineTo(bx,by);
        const c1x=bx+30, c1y=by, c2x=bx+30, c2y=by-p.drop, ex=bx-10, ey=by-p.drop;
        ctx.bezierCurveTo(c1x,c1y,c2x,c2y,ex,ey); ctx.stroke();
        
        ctx.fillStyle=isG?"#94a3b8":"#fff"; ctx.beginPath(); ctx.arc(bx,by,isG?2:3,0,Math.PI*2); ctx.fill(); if(!isG) ctx.stroke();
        ctx.restore();
    }

    init();
</script>
</body>
</html>
